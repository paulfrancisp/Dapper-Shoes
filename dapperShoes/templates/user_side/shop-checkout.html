{% extends 'user_side/base.html' %}
{% load static %}

{% block content%}
    <main class="main">
        {% comment %} <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="index.html" rel="nofollow">Home</a>
                    <span></span> Shop
                    <span></span> Checkout
                </div>
            </div>
        </div> {% endcomment %}
        <section class="mt-50 mb-50">
            <div class="container">
                {% comment %} <div class="row">
                    <div class="col-lg-6 mb-sm-15">
                        <div class="toggle_info">
                            <span><i class="fi-rs-user mr-10"></i><span class="text-muted">Already have an account?</span> <a href="#loginform" data-bs-toggle="collapse" class="collapsed" aria-expanded="false">Click here to login</a></span>
                        </div>
                        <div class="panel-collapse collapse login_form" id="loginform">
                            <div class="panel-body">
                                <p class="mb-30 font-sm">If you have shopped with us before, please enter your details below. If you are a new customer, please proceed to the Billing &amp; Shipping section.</p>
                                <form method="post">
                                    <div class="form-group">
                                        <input type="text" name="email" placeholder="Username Or Email">
                                    </div>
                                    <div class="form-group">
                                        <input type="password" name="password" placeholder="Password">
                                    </div>
                                    <div class="login_footer form-group">
                                        <div class="chek-form">
                                            <div class="custome-checkbox">
                                                <input class="form-check-input" type="checkbox" name="checkbox" id="remember" value="">
                                                <label class="form-check-label" for="remember"><span>Remember me</span></label>
                                            </div>
                                        </div>
                                        <a href="#">Forgot password?</a>
                                    </div>
                                    <div class="form-group">
                                        <button class="btn btn-md" name="login">Log in</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div> 
                    <div class="col-lg-6">
                        <div class="toggle_info">
                            <span><i class="fi-rs-label mr-10"></i><span class="text-muted">Have a coupon?</span> <a href="#coupon" data-bs-toggle="collapse" class="collapsed" aria-expanded="false">Click here to enter your code</a></span>
                        </div>
                        <div class="panel-collapse collapse coupon_form " id="coupon">
                            <div class="panel-body">
                                <p class="mb-30 font-sm">If you have a coupon code, please apply it below.</p>
                                <form method="post">
                                    <div class="form-group">
                                        <input type="text" placeholder="Enter Coupon Code...">
                                    </div>
                                    <div class="form-group">
                                        <button class="btn  btn-md" name="login">Apply Coupon</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>{% endcomment %}
                {% comment %} <div class="row">
                    <div class="col-12">
                        <div class="divider mt-50 mb-50"></div>
                    </div>
                </div> {% endcomment %}
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-25">
                            <h4>Billing Details</h4>
                        </div>
                        <form  id="myForm"  method="POST">           {% comment %} {% url 'order_app:place_order_cod' %} {% endcomment %}
                            {% csrf_token %}
                            <div class="row">
                                <div class="col">
                                    <div class="form-group">
                                        <input type="text" required="" name="first_name" placeholder="First name *" >                    {% comment %} {% if add_value %}value="{{ address.first_name }}"{% endif %} {% endcomment %}

                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-group">
                                        <input type="text" required="" name="last_name" placeholder="Last name *">
                                    </div>
                                </div>
                            </div>
                            
                            
                            {% comment %} <div class="form-group">
                                <input required="" type="text" name="cname" placeholder="Company Name">
                            </div> {% endcomment %}
                            <div class="form-group">
                                <input type="text" name="address" required="" placeholder="Address *">
                            </div>
                            {% comment %} <div class="form-group">
                                <input type="text" name="billing_address2" required="" placeholder="Address line2">
                            </div> {% endcomment %}
                            <div class="row">
                                <div class="col">
                                    <div class="form-group">
                                        <input required="" type="text" name="town_city" placeholder="City / Town *">
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-group">
                                        <input required="" type="text" name="state" placeholder="State *">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col">
                                    <div class="form-group">
                                        <input required="" type="text" name="zip_code" placeholder="Postcode / ZIP *">
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="form-group">
                                        <input required="" type="text" name="phone_number" placeholder="Phone *">
                                    </div>
                                </div>
                            </div>
                            
                            {% comment %} <div class="form-group">
                                <input required="" type="text" name="email" placeholder="Email address *">
                            </div> {% endcomment %}
                            {% comment %} <div class="form-group">
                                <div class="checkbox">
                                    <div class="custome-checkbox">
                                        <input class="form-check-input" type="checkbox" name="checkbox" id="createaccount">
                                        <label class="form-check-label label_info" data-bs-toggle="collapse" href="#collapsePassword" data-target="#collapsePassword" aria-controls="collapsePassword" for="createaccount"><span>Create an account?</span></label>
                                    </div>
                                </div>
                            </div>
                            <div id="collapsePassword" class="form-group create-account collapse in">
                                <input required="" type="password" placeholder="Password" name="password">
                            </div> {% endcomment %}





                            <div class="ship_detail">
                                <div class="form-group">
                                    <div class="check-form">
                                        <div class="custome-checkbox">
                                            <input class="form-check-input" type="checkbox" name="checkbox" id="differentaddress">
                                            <label class="form-check-label label_info" for="differentaddress"><span>Ship to home address?</span></label>
                                        </div>
                                    </div>
                                </div>
                                <div id="home_address_dropdown" class="different_address" style="display: none;">
                                    <div class="card mb-3 mb-lg-0">
                                        <div class="card-header">
                                            <h5 class="mb-0">Home Address</h5>
                                        </div>
                                        <div class="card-body">
                                            <address id="home_address">
                                                {{ address.first_name }} {{ address.last_name }}<br>
                                                {{ address.address }}<br>
                                                {{ address.town_city }}, {{ address.state }}-{{ address.zip_code }}<br>
                                                Ph: {{ address.phone_number }}
                                            </address>
                                            <a href="{% url 'account_app:account_edit_address' %}" class="btn-small">Edit</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            





                            
                            {% comment %} <div class="mb-20">
                                <h5>Additional information</h5>
                            </div>
                            <div class="form-group mb-30">
                                <textarea rows="5" placeholder="Order notes"></textarea>
                            </div> {% endcomment %}
                            <hr>
                            <div class="bt-1 border-color-1 mt-30 mb-30"></div>
                            <div class="payment_method">
                                <div class="mb-25">
                                    <h4>Payment</h4>
                                </div>


                                <div class="payment_option d-flex">
                                    <div class="col-md-3">
                                        <label >
                                            <div>
                                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio"  style="width: 30px; height: 30px;" name="payment-option" value="cod" checked>
                                                <p>Cash on delivery</p> 
                                            </div>
                                        </label>
                                    </div>
                                    <div class="col-md-2">
                                        <label>
                                            <div>
                                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <input type="radio" style="width: 30px; height: 30px;" name="payment-option" value="razorpay">
                                                <p>Razorpay</p> 
                                            </div>
                                        </label>
                                    </div>
                                    <div class="col-md-3">
                                        <label>
                                            <div>
                                                &nbsp;&nbsp;&nbsp;<input type="radio" style="width: 30px; height: 30px;" name="payment-option" value="wallet">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                                <p>Wallet</p>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                {% comment %} <div class="hidden mt-30 "> 
                                </div>{% endcomment %}

                                
                                <div id="card-button-container" >
                                    <button id="cod-button" type="submit" name="submit" class="btn btn-fill-out btn-block mt-30">Place Order</button>
                                </div>
                                <div id="card-button-container" >
                                    <button id="razorpay-button" type="submit" class="btn btn-fill-out btn-block mt-30" style="display: none;">Pay with Razorpay</button>
                                </div>
                                
                                <div id="card-button-container" >
                                    
                                    <button id="wallet-button" type="submit" class="btn btn-fill-out btn-block mt-30" style="display: none;">Pay from Wallet</button>
                                    <p class="ms-1" id="wallet-details" style="display: none;" >Wallet Balance: ₹<span id="wallet-balance"></span></p>
                                </div>
                                <p>
                                {% if messages %}
                                {% for message in messages %}
                                <span class="error" style="position: relative;top: 100%;left: 2px;font-size:14px;font-weight: 400;color: red;width: 190px;transition: opacity 0.5s;">{{message}}</span>
                                {% endfor %}
                                {% endif %}
                                </p>
                                 
                            </div>
                            {% comment %} <a href="#" class="btn btn-fill-out btn-block mt-30">Place Order</a> {% endcomment %}
                            {% comment %} <a href="{% url 'order_app:place_order_cod' %}"> {% endcomment %}
                            
                            {% comment %} {{ form.as_p }} {% endcomment %}
                            {% comment %} <button type="submit" name="submit" class="btn btn-fill-out btn-block mt-30">Place Order</button> {% endcomment %}
                            {% comment %} </a> {% endcomment %}

                        </form>  {% comment %} ###### Closing this FORM at the bottom ###### {% endcomment %}


                        {% comment %} <button id="rzp_button1">Pay with Razorpay</button> {% endcomment %}
                    </div>
                    <div class="col-md-6">
                        <div class="order_review" style="margin-top:-25px">
                            <div class="mb-20">
                                <h4>Your Orders</h4>
                            </div>
                            <div class="table-responsive order_table text-center">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Product Image</th>
                                            <th>Product</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for cart_item in cart_items %}
                                            <tr>
                                                <td class="image product-thumbnail "><img src="{{ cart_item.variant.thumbnail_image.url }}" alt="#"></td>
                                                <td>
                                                    <h5><a href="shop-product-full.html">{{ cart_item.variant.variant_name }}</a></h5> <span class="product-qty">Qty: {{ cart_item.quantity }}</span>
                                                </td>
                                                <td>{{ cart_item.variant.sale_price }} INR </td>
                                            </tr>


                                        {% endfor %}




                                        <tr>
                                            <th>SubTotal</th>
                                            <td class="product-subtotal" colspan="2">{{total}} INR</td>
                                        </tr>
                                        <tr>
                                            <th>Shipping</th>
                                            <td colspan="2"><em>Free Shipping</em></td>
                                        </tr>
                                        <tr>
                                            <th>Total</th>
                                            <td colspan="2" class="product-subtotal"><span class="font-xl text-brand fw-900">{{total}} INR</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            
                        </div>
                     {% comment %} </form> {% endcomment %}
                     <div class="mb-30 mt-50 me-3">
                        <div class="heading_s1 mb-3 ms-4">
                            <h4>&nbsp;Apply Coupon</h4>
                        </div>
                        <div class="total-amount">
                            <div class="left ms-4">
                                <div class="coupon">
                                    <form id="couponform">
                                        <div class="form-row row justify-content-center">     {% comment %} action="{% url 'user_app:user_login' %}" method="post" {% endcomment %}
                                            <div class="form-group col-lg-6">
                                                <input class="font-medium" name="Coupon" placeholder="Enter Your Coupon">
                                            </div>
                                            <div class="form-group col-lg-6">
                                                <button type="submit" class="btn  btn-sm"><i class="fi-rs-label mr-10"></i>Apply</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div> 


                    
                    </div>
                </div>
            </div>
        </section>
    </main>


    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    {% comment %} ---------- For cod, razorpay, wallet respective buttons to come up onclick ---------- {% endcomment %} 
    <script>
        // Get references to the buttons
        const codButton = document.getElementById('cod-button');
        const razorpayButton = document.getElementById('razorpay-button');
        const walletButton = document.getElementById('wallet-button');

        const walletDetails = document.getElementById('wallet-details');
        const walletBalance = document.getElementById('wallet-balance');
    
        // Add event listener to the radio buttons
        document.querySelectorAll('input[name="payment-option"]').forEach(function (radio) {
            radio.addEventListener('change', function () {
                // Check the value of the selected radio button
                if (this.value === 'cod') {
                    // If Cash on Delivery is selected, show the Place Order button and hide the Razorpay button
                    codButton.style.display = 'inline-block';
                    razorpayButton.style.display = 'none';
                    walletButton.style.display = 'none';
                    walletDetails.style.display = 'none';
                } else if (this.value === 'razorpay') {
                    // If Razorpay is selected, show the Razorpay button and hide the Place Order button
                    codButton.style.display = 'none';
                    walletButton.style.display = 'none';
                    walletDetails.style.display = 'none';
                    razorpayButton.style.display = 'inline-block';
                } else if (this.value === 'wallet') {
                    walletButton.style.display = 'block';
                    walletBalance.style.display = 'inline-block';
                    walletDetails.style.display = 'block';
                    razorpayButton.style.display = 'none';
                    codButton.style.display = 'none';
                    
                }
            });
        });
        const walletBalanceValue = {{user_wallet.balance}}; // Example value, replace with actual wallet balance
        walletBalance.textContent = walletBalanceValue;
    </script>


{% comment %} ---------- For coupon not to refresh the page ---------- {% endcomment %}       
<script>
    const form = document.getElementById('couponform');
    function handleSubmit (e){
            e.preventDefault()

            //fetch...........

    }

    form.addEventListener('submit', handleSubmit);
</script>



{% comment %} ---------- For order placement cod, razorpay, wallet ---------- {% endcomment %}    
<script>

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    document.getElementById("myForm").addEventListener("submit", function(event) {
        event.preventDefault(); // Prevent the default form submission behavior
        
        // Get the selected payment method
        const paymentMethod = document.querySelector('input[name="payment-option"]:checked').value;
        console.log(paymentMethod,'ppppppppppp')

        const shippingFirstName = document.querySelector('[name="first_name"]');
        const shippingLastName = document.querySelector('[name="last_name"]');
        const shippingPhoneNumber = document.querySelector('[name="phone_number"]');
        const shippingAddress = document.querySelector('[name="address"]');
        const shippingTownCity = document.querySelector('[name="town_city"]');
        const shippingState = document.querySelector('[name="state"]');
        const shippingZipCode = document.querySelector('[name="zip_code"]');

        const formData = {}

        formData.first_name = shippingFirstName.value;
        formData.last_name = shippingLastName.value;
        formData.phone_number = shippingPhoneNumber.value;
        formData.address = shippingAddress.value;
        formData.town_city = shippingTownCity.value;
        formData.state = shippingState.value;
        formData.zip_code = shippingZipCode.value;
        formData.selected_payment_method = paymentMethod;

        console.log(formData,'ddddddddd')


        if(paymentMethod === "cod"){

        fetch('{% url "order_app:place_order_cod" %}', {
        method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken,
                // Add any additional headers if needed
            },
            body: JSON.stringify({
            formData,

            }),
            })
            .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Network response was not ok.');
            }
        })
        .then(data => {
            console.log('Response333:', data);
            // Log the context if the response is successful
            window.location.href= "{% url 'order_app:success_page' %}";
            console.log('Context:', data.context);
            // You can handle the context data here
        })
        .catch(error => {
            console.error('Error:', error);
            
        });

                
        }

        if(paymentMethod === "razorpay"){
            fetch('{% url "order_app:place_order_cod" %}', {
                method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken,
                        // Add any additional headers if needed
                    },
                    body: JSON.stringify({
                    formData,
        
                    }),
                    })
                    .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Network response was not ok.');
                    }
                })
                .then(data => {
                    console.log('Response11111:', data);
                    // Log the context if the response is successful
                    //window.location.href= "{% url 'order_app:success_page' %}";
                    const order_id = data.context.order_id;
                    console.log(order_id)
                    var options = {
                        "key": "rzp_test_qoXpACMLfXbWKp", // Enter the Key ID generated from the Dashboard
                        "amount": data.context.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                        "currency": "INR",
                        "name": "Acme Corp",
                        "description": "Test Transaction",
                        "image": "https://example.com/your_logo",
                        "order_id": order_id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                        "callback_url": "http://127.0.0.1:8000/place_order_razpay/",
                        "prefill": {
                            "name": "Gaurav Kumar",
                            "email": "gaurav.kumar@example.com",
                            "contact": "9000090000"
                        },
                        "notes": {
                            "address": "Razorpay Corporate Office"
                        },
                        "theme": {
                            "color": "#3399cc"
                        }
                    };
                    var rzp1 = new Razorpay(options);
                    
                    rzp1.on("payment.success", function (response) {
                        // console.log('Payment success:', response);
                        window.location.reload(); // Reload the page after successful payment
                        // Handle payment success, e.g., redirect to a success page
                        //window.location.href= "{% url 'order_app:success_page' %}";
                    });

                    rzp1.on("payment.failed", function (response) {
                        //alert(response.error.code);
                        window.location.reload();
                        
                    });


                    rzp1.open();
                    e.preventDefault();
                    
                    console.log('Context:', data.context);
                    // You can handle the context data here
                })
                .catch(error => {
                    console.error('Error:', error);
                    
                });


        }

        if(paymentMethod === "wallet"){

            fetch('{% url "order_app:place_order_cod" %}', {
            method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken,
                    // Add any additional headers if needed
                },
                body: JSON.stringify({
                formData,
    
                }),
                })
                .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Network response was not ok.');
                }
            })
            .then(data => {
                console.log('Response333:', data);
                // Log the context if the response is successful
                window.location.href= "{% url 'order_app:success_page' %}";
                console.log('Context:', data.context);
                // You can handle the context data here
            })
            .catch(error => {
                console.error('Error:', error);
                //alert(error);
                window.location.reload();
                
            });
    
                    
            }


    });
    
    // Function to submit the form programmatically
    function customSubmit() {
        // Execute custom logic when the custom submit button is clicked
        console.log('Custom submit button clicked!');
        
        // You can add any additional logic here
        
        // If you want to submit the form programmatically, you can do so like this:
        document.getElementById('myForm').submit();
    }
    
</script>



    {% comment %} ---------- For shipping address ---------- {% endcomment %}
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const checkbox = document.getElementById('differentaddress');
            const homeAddress = document.getElementById('home_address');
    
            // Get shipping address fields
            const shippingFirstName = document.querySelector('[name="first_name"]');
            const shippingLastName = document.querySelector('[name="last_name"]');
            const shippingPhoneNumber = document.querySelector('[name="phone_number"]');
            const shippingAddress = document.querySelector('[name="address"]');
            const shippingTownCity = document.querySelector('[name="town_city"]');
            const shippingState = document.querySelector('[name="state"]');
            const shippingZipCode = document.querySelector('[name="zip_code"]');
    
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    // If checkbox is checked, populate shipping fields with home address details
                    const lines = homeAddress.textContent.trim().split('\n').map(line => line.trim());
                    const nameParts = lines[0].split(' ');
                    shippingFirstName.value = nameParts[0];
                    shippingLastName.value = nameParts.slice(1).join(' '); // Join remaining parts of the name
                    shippingPhoneNumber.value = lines[3].split(':')[1].trim();
    
                    shippingAddress.value = lines[1];
                    const cityStateParts = lines[2].split(',');
                    shippingTownCity.value = cityStateParts[0];
                    shippingState.value = cityStateParts[1].split('-')[0].trim();
                    shippingZipCode.value = cityStateParts[1].split('-')[1].trim();
                } else {
                    // If checkbox is unchecked, clear shipping fields
                    shippingFirstName.value = '';
                    shippingLastName.value = '';
                    shippingPhoneNumber.value = '';
    
                    shippingAddress.value = '';
                    shippingTownCity.value = '';
                    shippingState.value = '';
                    shippingZipCode.value = '';
                }
            });
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            let add_value = false; // Variable to track whether to add value to shipping fields
            const checkbox = document.getElementById('differentaddress');
            const homeAddressDropdown = document.getElementById('home_address_dropdown');
    
            checkbox.addEventListener('change', function() {
                console.log("Checkbox checked:", this.checked); // Debugging statement
                homeAddressDropdown.style.display = this.checked ? 'block' : 'none';
                console.log("Dropdown display:", homeAddressDropdown.style.display); // Debugging statement
                add_value = this.checked; // Set add_value to true if checkbox is checked
                console.log("add_value:", add_value); // Debugging statement
            });
    
            // Handle dropdown visibility initially based on checkbox state
            homeAddressDropdown.style.display = checkbox.checked ? 'block' : 'none';
        });
    </script> 

      
    

    {% endblock %} 